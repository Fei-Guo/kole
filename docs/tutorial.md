# KOLE DEMO

This tutorial describes how to deploy KOLE and use KOLE to conduct a bulk registration experiment.

## Environment

### Kubernetes

KOLE can be installed in any Kubernentes cluster with 1.20 or later release. 

### MQTT broker

KOLE works with any standard MQTT brokers. In this tutorial, we choose to install
an open-source EMQX broker using thea cluster deployment mode. Please refer to this [link](https://www.emqx.com/zh/blog/rapidly-deploy-emqx-clusters-on-kubernetes-via-helm)
for details. Note that a helm chart is provided for easy installation.
To access the broker service, we recommend to setup a LoadBalancer type of service with
a public IP as an ingress. We refer to the public IP as `LOADBALANCE_IP` in the rest of the document.

## Deploy KOLE

All instructions are done in the KOLE's root directory.
Two main components: kole-controller and lite-kubelet, as well as the CRD definitions will be installed in the `kole` namespace.

``` 
$ kubectl apply -f config/setup/manifest.yaml

namespace/kole created
service/kole-controller created
statefulset.apps/kole-controller created
configmap/lite-kubelet-start-signal created
service/lite-kubelet created
statefulset.apps/lite-kubelet created
customresourcedefinition.apiextensions.k8s.io/infdaemonsets.lite.openyurt.io created
customresourcedefinition.apiextensions.k8s.io/infedgenodes.lite.openyurt.io created
customresourcedefinition.apiextensions.k8s.io/querynodes.lite.openyurt.io created
customresourcedefinition.apiextensions.k8s.io/summaries.lite.openyurt.io created
clusterrole.rbac.authorization.k8s.io/kole created
clusterrolebinding.rbac.authorization.k8s.io/kole-rolebinding created
```

After all Pods are running and the LB type service is created successfully, we need to change the environment variable `MQTT5_SERVER` for the
kole-controller and lite-kubelet StatefulSets.

```
        env:
        - name: MQTT5_SERVER
          value: mqtt://8.142.157.229:1883
```

For example, we need to change the mqtt address from `mqtt://8.142.157.229:1883` to `mqtt://${LOADBALANCE_IP}:1883`.
This can be done using the `patch` API.

```
CONTROLLER_PATCH=$(cat <<- EOF
spec:
  template:
    spec:
      containers:
      - name: kole-controller
        env:
        - name: MQTT5_SERVER
          value: "mqtt://{LOADBALANCE_IP}:1883"
EOF
)

 $ kubectl patch -n kole statefulsets.apps kole-controller  --patch "$CONTROLLER_PATCH"
 
 LITE_KUBELET_PATCH=$(cat <<- EOF
spec:
  template:
    spec:
      containers:
      - name: lite-kubelet
        env:
        - name: MQTT5_SERVER
          value: "mqtt://{LOADBALANCE_IP}:1883"
EOF
)
 
$ kubectl patch -n kole statefulsets.apps lite-kubelet --patch "$CONTROLLER_PATCH"

```
With the above, we setup KOLE with one node being registered. We can check the controller and the lite-kubelet, i.e., the edge client, logs to 
understand the design..


## Test the bulk registration


The `test/script/storm.sh` script is used to simulatee the bulk registration. Using the `start` command will create 200 load generator pods and
100K edge clients will be created by them in total. The workload will be evenly distributed across the Pods.

```
$ ./test/script/storm.sh start

```

To change the number of edge clients and the number of pods, one can modify the following parameters in the script:

```
POD_NUMS=`expr 200`
TOTAL_LITE_KUBELET_NUM=`expr 100000`
```

When all load generator pods are created successfully, the following log is printed:

```
The time required to create the last POD is *** s
```

After all pods are created, we need to modify a configMap so that they can start to create edge clients simultaneously.
The configmap is named `lite-kubelet-start-signal` in `kole` namespace. The trigger is to change the `test` field in the data.

```
$ kubectl get cm -n kole  lite-kubelet-start-signal -o yaml
apiVersion: v1

kind: ConfigMap
data:
  test: start
```

For example, we can modify the value to `start-round1` using the following command:

```
CM_PATCH=$(cat <<- EOF
data:
  test: start-round1
EOF
)

$ kubectl patch -n kole cm lite-kubelet-start-signal  --patch "$CM_PATCH"
```

We can continue to monitor the logs generated by the script.
If all registers are done, a log similar to the following will be printed in the output:

```
All Lite-Kubelet registrations take *** ms

```

also, we can check the log of the kole-controller controller to see the number of registered hostsï¼š

```
$ kubectl -n kole logs -f kole-controller-0
```
